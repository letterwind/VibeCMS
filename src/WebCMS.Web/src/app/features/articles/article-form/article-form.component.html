<form [formGroup]="form" (ngSubmit)="onSubmit()" class="p-3">
  <!-- 標題 -->
  <div class="mb-3">
    <label for="title" class="form-label"
      >{{ "article.title" | translate }}
      <span class="text-danger">*</span></label
    >
    <input
      type="text"
      class="form-control"
      id="title"
      formControlName="title"
      [class.is-invalid]="
        form.get('title')?.invalid && form.get('title')?.touched
      "
      maxlength="200"
    />
    <div class="form-text">
      {{ "validation.maxLengthWithCount" | translate: [200] }} ({{
        form.get("title")?.value?.length || 0
      }}/200)
    </div>
    <app-validation-error
      [control]="form.get('title')"
      [fieldName]="'article.title' | translate"
    >
    </app-validation-error>
  </div>

  <!-- 網址代稱 -->
  <div class="mb-3">
    <label for="slug" class="form-label"
      >{{ "common.slug" | translate }} <span class="text-danger">*</span></label
    >
    <div class="input-group">
      <span class="input-group-text">/article/</span>
      <input
        type="text"
        class="form-control"
        id="slug"
        formControlName="slug"
        [class.is-invalid]="
          form.get('slug')?.invalid && form.get('slug')?.touched
        "
        maxlength="200"
      />
    </div>
    <app-validation-error
      [control]="form.get('slug')"
      [fieldName]="'common.slug' | translate"
    >
    </app-validation-error>
  </div>

  <!-- 分類 -->
  <div class="mb-3">
    <label for="categoryId" class="form-label"
      >{{ "label.category" | translate }}
      <span class="text-danger">*</span></label
    >
    <select
      class="form-select"
      id="categoryId"
      formControlName="categoryId"
      [class.is-invalid]="
        form.get('categoryId')?.invalid && form.get('categoryId')?.touched
      "
    >
      <option value="">{{ "common.selectCategory" | translate }}</option>
      @for (category of categories; track category.id) {
        <option [value]="category.id">
          {{ getLevelPrefix(category.level) }}{{ category.name }}
        </option>
      }
    </select>
    <app-validation-error
      [control]="form.get('categoryId')"
      [fieldName]="languageService.getTranslation('label.category')"
      [customMessages]="{
        required: languageService.getTranslation('common.selectCategory'),
      }"
    >
    </app-validation-error>
  </div>

  <!-- 標籤 -->
  <div class="mb-3">
    <label for="tags" class="form-label">{{
      "article.tags" | translate
    }}</label>
    <div class="input-group">
      <input
        type="text"
        class="form-control"
        id="newTag"
        [(ngModel)]="newTag"
        [ngModelOptions]="{ standalone: true }"
        placeholder="{{ 'article.tagPlaceholder' | translate }}"
        (keydown.enter)="addTag($event)"
      />
      <button
        class="btn btn-outline-secondary"
        type="button"
        (click)="addTag()"
      >
        <i class="bi bi-plus"></i> {{ "common.add" | translate }}
      </button>
    </div>
    <div class="mt-2">
      @for (tag of tags; track tag) {
        <span class="badge bg-primary me-1 mb-1">
          {{ tag }}
          <button
            type="button"
            class="btn-close btn-close-white ms-1"
            style="font-size: 0.6rem"
            (click)="removeTag(tag)"
          ></button>
        </span>
      }
    </div>
    @if (existingTags.length > 0) {
      <div class="mt-2">
        <small class="text-muted"
          >{{ "article.tagSuggest" | translate }}：</small
        >
        @for (tag of existingTags; track tag) {
          @if (!tags.includes(tag)) {
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary me-1 mb-1"
              (click)="addExistingTag(tag)"
            >
              {{ tag }}
            </button>
          }
        }
      </div>
    }
  </div>

  <!-- 內容 (TinyMCE) -->
  <div class="mb-3">
    <label for="content" class="form-label"
      >{{ "article.content" | translate }}
      <span class="text-danger">*</span></label
    >
    <editor [init]="init" licenseKey="gpl" formControlName="content" />
    <app-validation-error
      [control]="form.get('content')"
      [fieldName]="'article.content' | translate"
    >
    </app-validation-error>
  </div>

  <!-- SEO 設定 -->
  <div class="card mb-3">
    <div class="card-header">
      <i class="bi bi-search me-1"></i>{{ "common.seoSetting" | translate }}
    </div>
    <div class="card-body">
      <div class="mb-3">
        <label for="metaTitle" class="form-label">{{
          "common.seoTitle" | translate
        }}</label>
        <input
          type="text"
          class="form-control"
          id="metaTitle"
          formControlName="metaTitle"
          maxlength="100"
        />
        <div class="form-text">
          {{ "validation.maxLength" | translate: [100] }}
        </div>
        <app-validation-error
          [control]="form.get('metaTitle')"
          [fieldName]="'common.seoTitle' | translate"
        >
        </app-validation-error>
      </div>
      <div class="mb-3">
        <label for="metaDescription" class="form-label">{{
          "common.seoDescription" | translate
        }}</label>
        <textarea
          class="form-control"
          id="metaDescription"
          formControlName="metaDescription"
          rows="2"
          maxlength="200"
        ></textarea>
        <div class="form-text">
          {{ "validation.maxLength" | translate: [200] }}
        </div>
        <app-validation-error
          [control]="form.get('metaDescription')"
          [fieldName]="'common.seoDescription' | translate"
        >
        </app-validation-error>
      </div>
      <div class="mb-3">
        <label for="metaKeywords" class="form-label">{{
          "common.seoKeywords" | translate
        }}</label>
        <input
          type="text"
          class="form-control"
          id="metaKeywords"
          formControlName="metaKeywords"
          placeholder="{{ 'common.splitByComma' | translate }}"
          maxlength="200"
        />
        <div class="form-text">
          {{ "validation.maxLength" | translate: [200] }}
        </div>
        <app-validation-error
          [control]="form.get('metaKeywords')"
          [fieldName]="'common.seoKeywords' | translate"
        >
        </app-validation-error>
      </div>
    </div>
  </div>

  <!-- 按鈕 -->
  <div class="d-flex justify-content-end gap-2">
    <button type="button" class="btn btn-secondary" (click)="onCancel.emit()">
      {{ "common.cancel" | translate }}
    </button>
    <button
      type="submit"
      class="btn btn-primary"
      [disabled]="form.invalid || isSubmitting"
    >
      @if (isSubmitting) {
        <span class="spinner-border spinner-border-sm me-1"></span>
      }
      {{
        isEditing
          ? languageService.getTranslation("label.update")
          : languageService.getTranslation("label.create")
      }}
    </button>
  </div>
</form>
