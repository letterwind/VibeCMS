<form [formGroup]="form" (ngSubmit)="onSubmit()">
  <div class="mb-3">
    <label for="name" class="form-label"
      >功能名稱 <span class="text-danger">*</span></label
    >
    <input
      type="text"
      class="form-control"
      id="name"
      formControlName="name"
      maxlength="100"
      [class.is-invalid]="isFieldInvalid('name')"
    />
    <div class="form-text">最多 100 字元</div>
    <app-validation-error [control]="form.get('name')" [fieldName]="'功能名稱'">
    </app-validation-error>
  </div>

  <div class="mb-3">
    <label for="code" class="form-label"
      >功能代碼 <span class="text-danger">*</span></label
    >
    <input
      type="text"
      class="form-control"
      id="code"
      formControlName="code"
      maxlength="50"
      [class.is-invalid]="isFieldInvalid('code')"
    />
    <div class="form-text">
      唯一識別碼，例如：dashboard、user-management，最多 50 字元
    </div>
    <app-validation-error [control]="form.get('code')" [fieldName]="'功能代碼'">
    </app-validation-error>
  </div>

  <div class="mb-3">
    <label for="url" class="form-label">連結網址</label>
    <input
      type="text"
      class="form-control"
      id="url"
      formControlName="url"
      placeholder="/admin/dashboard"
      maxlength="500"
      [class.is-invalid]="isFieldInvalid('url')"
    />
    <div class="form-text">最多 500 字元</div>
    <app-validation-error [control]="form.get('url')" [fieldName]="'連結網址'">
    </app-validation-error>
  </div>

  <div class="mb-3">
    <label for="parentId" class="form-label">父功能</label>
    <select class="form-select" id="parentId" formControlName="parentId">
      <option [ngValue]="null">無（頂層功能）</option>
      @for (option of flattenedParentOptions; track option.id) {
        <option [ngValue]="option.id">
          {{ option.indent }}{{ option.name }} ({{ option.code }})
        </option>
      }
    </select>
  </div>

  <div class="mb-3">
    <label class="form-label">圖示</label>
    <div class="input-group mb-2">
      @if (form.get("icon")?.value) {
        <span class="input-group-text">
          <i [class]="'bi ' + form.get('icon')?.value"></i>
        </span>
      }
      <input
        type="text"
        class="form-control"
        formControlName="icon"
        placeholder="bi-house"
        readonly
      />
      <button
        type="button"
        class="btn btn-outline-secondary"
        (click)="toggleIconPicker()"
      >
        <i class="bi bi-grid-3x3-gap"></i> 選擇
      </button>
    </div>

    <!-- Icon Picker -->
    @if (showIconPicker) {
      <div class="card">
        <div class="card-body">
          <div class="mb-2">
            <input
              type="text"
              class="form-control form-control-sm"
              placeholder="搜尋圖示..."
              [(ngModel)]="iconSearchTerm"
              [ngModelOptions]="{ standalone: true }"
            />
          </div>
          <div class="icon-grid">
            @for (icon of filteredIcons; track icon) {
              <button
                type="button"
                class="btn btn-outline-secondary icon-btn"
                [class.active]="form.get('icon')?.value === icon"
                (click)="selectIcon(icon)"
                [title]="icon"
              >
                <i [class]="'bi ' + icon"></i>
              </button>
            }
          </div>
        </div>
      </div>
    }
  </div>

  <div class="mb-3">
    <div class="form-check">
      <input
        type="checkbox"
        class="form-check-input"
        id="openInNewWindow"
        formControlName="openInNewWindow"
      />
      <label class="form-check-label" for="openInNewWindow">
        在新視窗開啟
      </label>
    </div>
  </div>

  <div class="mb-3">
    <label for="sortOrder" class="form-label">排序順序</label>
    <input
      type="number"
      class="form-control"
      id="sortOrder"
      formControlName="sortOrder"
      min="0"
    />
    <div class="form-text">數字越小排序越前面</div>
  </div>

  <div class="d-flex justify-content-end gap-2 mt-4">
    <button type="button" class="btn btn-secondary" (click)="onCancel.emit()">
      取消
    </button>
    <button
      type="submit"
      class="btn btn-primary"
      [disabled]="form.invalid || isSubmitting"
    >
      @if (isSubmitting) {
        <span class="spinner-border spinner-border-sm me-1"></span>
      }
      {{ isEditing ? "更新" : "建立" }}
    </button>
  </div>
</form>
