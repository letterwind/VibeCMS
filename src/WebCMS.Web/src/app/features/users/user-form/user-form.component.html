<form [formGroup]="form" (ngSubmit)="onSubmit()">
  <!-- 帳號 -->
  <div class="mb-3">
    <label for="account" class="form-label"
      >{{ "user.account" | translate }}
      <span class="text-danger">*</span></label
    >
    <input
      type="text"
      class="form-control"
      id="account"
      formControlName="account"
      [readonly]="isEditing"
      [class.is-invalid]="isFieldInvalid('account')"
      [class.is-valid]="isFieldValid('account')"
    />
    <div class="form-text">{{ "user.accountHint" | translate }}</div>
    <app-validation-error
      [control]="form.get('account')"
      [fieldName]="'user.account' | translate"
      [customMessages]="{
        accountFormat:
          form.get('account')?.errors?.['accountFormat'] ||
          languageService.getTranslation('user.accountFormatError'),
        serverValidation: form.get('account')?.errors?.['serverValidation'],
      }"
    >
    </app-validation-error>
  </div>

  <!-- 密碼 -->
  <div class="mb-3">
    <label for="password" class="form-label">
      {{
        isEditing
          ? ("user.newPassword" | translate)
          : ("user.password" | translate)
      }}
      @if (!isEditing) {
        <span class="text-danger">*</span>
      }
    </label>
    <input
      type="password"
      class="form-control"
      id="password"
      formControlName="password"
      [class.is-invalid]="isFieldInvalid('password')"
      [class.is-valid]="isFieldValid('password')"
    />
    <div class="form-text">
      @if (isEditing) {
        {{ "user.passwordEditHint" | translate }}
      }
      {{ "user.passwordHint" | translate }}
    </div>
    <app-validation-error
      [control]="form.get('password')"
      [fieldName]="'user.password' | translate"
      [customMessages]="{
        passwordFormat:
          form.get('password')?.errors?.['passwordFormat'] ||
          languageService.getTranslation('user.passwordFormatError'),
        passwordContainsAccount: languageService.getTranslation(
          'user.passwordContainsAccount'
        ),
        serverValidation: form.get('password')?.errors?.['serverValidation'],
      }"
    >
    </app-validation-error>
  </div>

  <!-- 顯示名稱 -->
  <div class="mb-3">
    <label for="displayName" class="form-label"
      >{{ "user.displayName" | translate }}
      <span class="text-danger">*</span></label
    >
    <input
      type="text"
      class="form-control"
      id="displayName"
      formControlName="displayName"
      maxlength="100"
      [class.is-invalid]="isFieldInvalid('displayName')"
    />
    <div class="form-text">
      {{ "validation.maxCharacters" | translate: [100] }}
    </div>
    <app-validation-error
      [control]="form.get('displayName')"
      [fieldName]="'user.displayName' | translate"
    >
    </app-validation-error>
  </div>

  <!-- 角色 -->
  <div class="mb-3">
    <label class="form-label">{{ "label.role" | translate }}</label>
    <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto">
      @for (role of roles; track role.id) {
        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            [id]="'role-' + role.id"
            [checked]="isRoleSelected(role.id)"
            (change)="toggleRole(role.id)"
          />
          <label class="form-check-label" [for]="'role-' + role.id">
            {{ role.name }}
            @if (role.description) {
              <small class="text-muted">- {{ role.description }}</small>
            }
          </label>
        </div>
      }
      @if (roles.length === 0) {
        <div class="text-muted">{{ "user.noRoles" | translate }}</div>
      }
    </div>
  </div>

  <!-- 錯誤訊息 -->
  @if (errorMessage) {
    <div class="alert alert-danger">{{ errorMessage }}</div>
  }

  <div class="d-flex justify-content-end gap-2 mt-4">
    <button type="button" class="btn btn-secondary" (click)="onCancel.emit()">
      {{ "common.cancel" | translate }}
    </button>
    <button
      type="submit"
      class="btn btn-primary"
      [disabled]="isSubmitting || (!isEditing && form.invalid)"
    >
      @if (isSubmitting) {
        <span class="spinner-border spinner-border-sm me-1"></span>
      }
      {{
        isEditing ? ("label.update" | translate) : ("label.create" | translate)
      }}
    </button>
  </div>
</form>
